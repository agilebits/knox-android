android:publish:
  stage: publish
  image: "${CI_REGISTRY_IMAGE}/gutenberg-slim:1"
  rules:
    - if: "$CI_COMMIT_REF_NAME =~ /^release-/"
      changes:
        - platforms/android/gradle.properties
      when: on_success
      allow_failure: false
  script:
    # In the pipeline, the value of `$(tty)` is `not a tty`, so we can’t assign `$(tty)` to `GPG_TTY`.
    - export GPG_TTY=/dev/tty0
    - export OP_CONNECT_TOKEN=$OP_CONNECT_TOKEN_MASKED_ONLY
    - scripts/publication-setup.sh
    - scripts/publish-package.sh android 1.0.0-test.2 --dry-run
    - scripts/publication-teardown.sh

android:test:
  stage: .pre
  image: "${CI_REGISTRY_IMAGE}/gutenberg:1"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - platforms/android/**/*
      when: on_success
      allow_failure: false
  script:
    # In the pipeline, the value of `$(tty)` is `not a tty`, so we can’t assign `$(tty)` to `GPG_TTY`.
    - export GPG_TTY=/dev/tty0
    - export OP_CONNECT_TOKEN=$OP_CONNECT_TOKEN_MASKED_ONLY
    - scripts/publication-setup.sh
    - scripts/publish-package.sh android 1.0.0-test.2 --to-maven --branch=ed/test
    - scripts/publication-teardown.sh
